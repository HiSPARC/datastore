<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>datastore WSGI app package &#8212; HiSPARC-datastore 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css?v=279e0f84" />
    <link rel="stylesheet" type="text/css" href="_static/hisparc_style.css?v=71c9f363" />
    <script src="_static/documentation_options.js?v=8d563738"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="datastore writer package" href="writer.html" />
    <link rel="prev" title="Introduction" href="introduction.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="writer.html" title="datastore writer package"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="introduction.html" title="Introduction"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">HiSPARC-datastore 1.0.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">datastore WSGI app package</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="module-wsgi">
<span id="datastore-wsgi-app-package"></span><h1>datastore WSGI app package<a class="headerlink" href="#module-wsgi" title="Link to this heading">¶</a></h1>
<p>HiSPARC datastore WSGI application</p>
<p>This WSGI app is served by uWSGI on frome and lives at
<code class="docutils literal notranslate"><span class="pre">http://frome.nikef.nl/hisparc/upload</span></code>.</p>
<p>example <code class="docutils literal notranslate"><span class="pre">application.wsgi</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/var/www/wsgi-bin/datastore&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">wsgi</span> <span class="kn">import</span> <span class="n">wsgi_app</span>

<span class="n">configfile</span> <span class="o">=</span> <span class="s1">&#39;/var/www/wsgi-bin/datastore/examples/config.ini&#39;</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">wsgi_app</span><span class="o">.</span><span class="n">application</span><span class="p">,</span> <span class="n">configfile</span><span class="o">=</span><span class="n">configfile</span><span class="p">)</span>
</pre></div>
</div>
<p>configuration is read from a configuation file, shared between the WSGI app
and the writer usually <cite>config.ini</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">General</span><span class="p">]</span>
<span class="n">log</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hisparc</span><span class="o">.</span><span class="n">log</span>
<span class="n">loglevel</span><span class="o">=</span><span class="n">debug</span>
<span class="n">station_list</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">station_list</span><span class="o">.</span><span class="n">csv</span>
<span class="n">data_dir</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">datastore</span>

<span class="p">[</span><span class="n">Writer</span><span class="p">]</span>
<span class="n">sleep</span><span class="o">=</span><span class="mi">5</span>
</pre></div>
</div>
<section id="module-wsgi.rcodes">
<span id="wsgi-rcodes-module"></span><h2>wsgi.rcodes module<a class="headerlink" href="#module-wsgi.rcodes" title="Link to this heading">¶</a></h2>
<p>Return codes for the WSGI app.</p>
<p>There are four types of return codes:</p>
<ol class="arabic">
<li><p>OK (100)</p></li>
<li><p>putEvent errors (20*)</p>
<ul class="simple">
<li><p>201: invalid input: checksum of data does not match</p></li>
<li><p>203: wrong password</p></li>
<li><p>206: station unknown (check <code class="docutils literal notranslate"><span class="pre">station-list.csv</span></code>)</p></li>
<li><p>208: unpickling error</p></li>
</ul>
</li>
<li><p>getEvent errors (30*)</p>
<p>not used by WSGI app</p>
</li>
<li><p>Internal server error (40*)</p>
<ul class="simple">
<li><p>400: internal server error. Invalid post data.</p></li>
</ul>
</li>
</ol>
</section>
<section id="module-wsgi.wsgi_app">
<span id="wsgi-wsgi-app-module"></span><h2>wsgi.wsgi_app module<a class="headerlink" href="#module-wsgi.wsgi_app" title="Link to this heading">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="wsgi.wsgi_app.application">
<span class="sig-prename descclassname"><span class="pre">wsgi.wsgi_app.</span></span><span class="sig-name descname"><span class="pre">application</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">environ</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">start_response</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">configfile</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/wsgi/wsgi_app.html#application"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#wsgi.wsgi_app.application" title="Link to this definition">¶</a></dt>
<dd><p>The hisparc upload application</p>
<p>This handler is called by uWSGI whenever someone requests our URL.</p>
<p>First, we generate a dictionary of POSTed variables and try to read out the
station_id, password, checksum and data. When we do a readline(), we
already read out the entire datastream. I don’t know if we can first check
on station_id/password combinations before reading out the datastream
without setting up a bidirectional communication channel.</p>
<p>When the checksum matches, we unpickle the event_list and pass everything
on to store_event_list.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="wsgi.wsgi_app.decode_object">
<span class="sig-prename descclassname"><span class="pre">wsgi.wsgi_app.</span></span><span class="sig-name descname"><span class="pre">decode_object</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">o</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/wsgi/wsgi_app.html#decode_object"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#wsgi.wsgi_app.decode_object" title="Link to this definition">¶</a></dt>
<dd><p>recursively decode all bytestrings in object</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="wsgi.wsgi_app.do_init">
<span class="sig-prename descclassname"><span class="pre">wsgi.wsgi_app.</span></span><span class="sig-name descname"><span class="pre">do_init</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">configfile</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/wsgi/wsgi_app.html#do_init"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#wsgi.wsgi_app.do_init" title="Link to this definition">¶</a></dt>
<dd><p>Load configuration and passwords and set up a logger handler</p>
<p>This function will do one-time initialization.  By using global
variables, we eliminate the need to reread configuration and passwords
on every request.</p>
<p>Configuration is read from the datastore configuation file (usually
<cite>config.ini</cite>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">General</span><span class="p">]</span>
<span class="n">log</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hisparc</span><span class="o">.</span><span class="n">log</span>
<span class="n">loglevel</span><span class="o">=</span><span class="n">debug</span>
<span class="n">station_list</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">station_list</span><span class="o">.</span><span class="n">csv</span>
<span class="n">data_dir</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">datastore</span>

<span class="p">[</span><span class="n">Writer</span><span class="p">]</span>
<span class="n">sleep</span><span class="o">=</span><span class="mi">5</span>
</pre></div>
</div>
<p>Station information is read from the <cite>station_list</cite> config variable.
(<cite>station_list.csv</cite> on frome)</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="wsgi.wsgi_app.is_data_suspicious">
<span class="sig-prename descclassname"><span class="pre">wsgi.wsgi_app.</span></span><span class="sig-name descname"><span class="pre">is_data_suspicious</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">event_list</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/wsgi/wsgi_app.html#is_data_suspicious"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#wsgi.wsgi_app.is_data_suspicious" title="Link to this definition">¶</a></dt>
<dd><p>Check data for suspiciousness</p>
<p>Suspiciousness, a previously unknown quantum number that may signify
the actual birth of the universe and the reweaving of past fates into
current events has come to hunt us and our beloved data.</p>
<p>Note: Apr 7, 2019 0:00 is the default time after a cold start without GPS signal.
The DAQ will happily send events even when no GPS signal has been
acquired (yet). Events with timestamp Apr 7, 2019 are most probably caused
by no or bad GPS signal. Such events must be eigenstates of suspiciousness.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="wsgi.wsgi_app.store_data">
<span class="sig-prename descclassname"><span class="pre">wsgi.wsgi_app.</span></span><span class="sig-name descname"><span class="pre">store_data</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">station_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cluster</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">event_list</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/wsgi/wsgi_app.html#store_data"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#wsgi.wsgi_app.store_data" title="Link to this definition">¶</a></dt>
<dd><p>Store verified event data to temporary storage</p>
</dd></dl>

</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/header.png" alt="Logo of HiSPARC-datastore"/>
            </a></p>
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">datastore WSGI app package</a><ul>
<li><a class="reference internal" href="#module-wsgi.rcodes">wsgi.rcodes module</a></li>
<li><a class="reference internal" href="#module-wsgi.wsgi_app">wsgi.wsgi_app module</a><ul>
<li><a class="reference internal" href="#wsgi.wsgi_app.application"><code class="docutils literal notranslate"><span class="pre">application()</span></code></a></li>
<li><a class="reference internal" href="#wsgi.wsgi_app.decode_object"><code class="docutils literal notranslate"><span class="pre">decode_object()</span></code></a></li>
<li><a class="reference internal" href="#wsgi.wsgi_app.do_init"><code class="docutils literal notranslate"><span class="pre">do_init()</span></code></a></li>
<li><a class="reference internal" href="#wsgi.wsgi_app.is_data_suspicious"><code class="docutils literal notranslate"><span class="pre">is_data_suspicious()</span></code></a></li>
<li><a class="reference internal" href="#wsgi.wsgi_app.store_data"><code class="docutils literal notranslate"><span class="pre">store_data()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="introduction.html"
                          title="previous chapter">Introduction</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="writer.html"
                          title="next chapter">datastore writer package</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/wsgi.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="writer.html" title="datastore writer package"
             >next</a> |</li>
        <li class="right" >
          <a href="introduction.html" title="Introduction"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">HiSPARC-datastore 1.0.0 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">datastore WSGI app package</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2017, David Fokkema, Arne de Laat, Tom Kooij.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>